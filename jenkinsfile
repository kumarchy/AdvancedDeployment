pipeline {
    agent any

    environment {
        // Jenkins credential ID for Salesforce username and password+token
        SF_USERNAME = credentials('SF_USERNAME')      // Jenkins credentials (username)
        SF_PASSWORD = credentials('SF_PASSWORD')      // Jenkins credentials (password+token)
        SF_SERVERURL = "https://login.salesforce.com" // or https://test.salesforce.com for sandbox
        ANT_HOME = "C:\\apache-ant"                   // Path to your Apache Ant
        PATH = "${env.PATH};${env.ANT_HOME}\\bin"     // Add Ant to PATH
    }

    stages {
        stage('Checkout Code') {
            steps {
                echo 'Checking out source code...'
                checkout scm
            }
        }

        stage('Identify Changed Metadata') {
            steps {
                echo 'Detecting changes between commits...'
                script {
                    // Compare last successful build commit to current one
                    def prevCommit = sh(script: "git rev-parse HEAD~1", returnStdout: true).trim()
                    def currCommit = sh(script: "git rev-parse HEAD", returnStdout: true).trim()

                    echo "Comparing commits: ${prevCommit} -> ${currCommit}"

                    sh '''
                        rm -rf delta
                        mkdir delta

                        git diff --name-only HEAD~1 HEAD > changed_files.txt
                        echo "Changed files:"
                        cat changed_files.txt

                        while IFS= read -r file
                        do
                          if [[ $file == src/* ]]; then
                            mkdir -p "delta/$(dirname "$file")"
                            cp "$file" "delta/$file"
                          fi
                        done < changed_files.txt
                    '''
                }
            }
        }

        stage('Generate Delta Package.xml') {
            steps {
                echo 'Generating delta package.xml...'
                writeFile file: 'delta/package.xml', text: '''<?xml version="1.0" encoding="UTF-8"?>
<Package xmlns="http://soap.sforce.com/2006/04/metadata">
    <types>
        <members>*</members>
        <name>ApexClass</name>
    </types>
    <types>
        <members>*</members>
        <name>ApexTrigger</name>
    </types>
    <types>
        <members>*</members>
        <name>LightningComponentBundle</name>
    </types>
    <version>59.0</version>
</Package>
'''
            }
        }

        stage('Deploy Delta using Ant') {
            steps {
                echo 'Starting Salesforce delta deployment...'
                writeFile file: 'build.properties', text: """
sf.username=${SF_USERNAME}
sf.password=${SF_PASSWORD}
sf.serverurl=${SF_SERVERURL}
"""
                writeFile file: 'build.xml', text: '''<?xml version="1.0" encoding="UTF-8"?>
<project name="SalesforceDeltaDeployment" default="deployDelta">
    <property file="build.properties"/>
    <target name="deployDelta">
        <sf:deploy username="${sf.username}"
                   password="${sf.password}"
                   serverurl="${sf.serverurl}"
                   deployRoot="delta"
                   testLevel="RunLocalTests"
                   rollbackOnError="true"
                   ignoreWarnings="true"
                   checkOnly="false"/>
    </target>
</project>
'''
                // Run Ant deployment
                sh "ant deployDelta"
            }
        }
    }

    post {
        success {
            echo "✅ Deployment successful!"
        }
        failure {
            echo "❌ Deployment failed. Check the logs for details."
        }
    }
}

