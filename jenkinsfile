pipeline {
    agent any

    options {
        skipDefaultCheckout(true)
    }

    environment {
        SF_CREDENTIALS = 'deltaDeployment'
        ANT_HOME = tool 'Ant'
        PATH = "${ANT_HOME}/bin;${env.PATH}"

        DEPLOY_STATUS = 'SKIPPED'
        DEPLOY_ERROR  = ''

        COMMIT_HASH    = ''
        COMMIT_AUTHOR  = ''
        COMMIT_MESSAGE = ''
        CODE_DIFF      = ''
        CURRENT_TIME   = ''
    }

    stages {

        stage('Checkout') {
            steps {
                echo 'üì• Checking out source code...'
                checkout scm
            }
        }

        stage('Collect Commit Details') {
    steps {
        script {
            // Fix for Windows date/time
            env.CURRENT_TIME = bat(
                script: '@echo %date% %time%',
                returnStdout: true
            ).trim()

            // More reliable git commands with error handling
            try {
                env.COMMIT_HASH = bat(
                    script: '@git rev-parse HEAD',
                    returnStdout: true
                ).trim()

                env.COMMIT_AUTHOR = bat(
                    script: '@git log -1 --pretty=format:%%an',
                    returnStdout: true
                ).trim()

                env.COMMIT_MESSAGE = bat(
                    script: '@git log -1 --pretty=format:%%s',
                    returnStdout: true
                ).trim()

                env.CODE_DIFF = bat(
                    script: '@git diff --name-status HEAD~1 HEAD',
                    returnStdout: true
                ).trim()
            } catch (Exception e) {
                echo "Warning: Git commands failed: ${e.message}"
                env.COMMIT_HASH = 'N/A'
                env.COMMIT_AUTHOR = 'N/A'
                env.COMMIT_MESSAGE = 'N/A'
                env.CODE_DIFF = 'Unable to retrieve'
            }

            if (!env.CODE_DIFF || env.CODE_DIFF == '') {
                env.CODE_DIFF = 'No file changes detected'
            }
            
            echo "Commit Hash: ${env.COMMIT_HASH}"
            echo "Author: ${env.COMMIT_AUTHOR}"
            echo "Message: ${env.COMMIT_MESSAGE}"
        }
    }
}

        stage('Generate Delta Package') {
            steps {
                echo 'üîç Generating Salesforce delta...'
                bat 'scripts\\find-changes.bat'
            }
        }

        stage('Validate & Deploy Delta') {
    steps {
        script {
            if (!fileExists('delta\\src') || !fileExists('delta\\package.xml')) {
                echo '‚ö†Ô∏è No delta found. Skipping deployment.'
                env.DEPLOY_STATUS = 'SKIPPED'
                return
            }

            withCredentials([usernamePassword(
                credentialsId: env.SF_CREDENTIALS,
                usernameVariable: 'SF_USERNAME',
                passwordVariable: 'SF_PASSWORD'
            )]) {
                bat """
                    ant -Dsf.username=%SF_USERNAME% ^
                        -Dsf.password=%SF_PASSWORD% ^
                        -Dsf.serverurl=https://login.salesforce.com ^
                        -buildfile build\\build.xml ^
                        deltaDeploy
                """
                env.DEPLOY_STATUS = 'SUCCESS'
            }
        }
    }
}

    }

    post {
        always {
            script {
                withCredentials([string(credentialsId: 'teams-webhook', variable: 'TEAMS_URL')]) {

                    def shortCommit = env.COMMIT_HASH ? env.COMMIT_HASH.take(8) : 'N/A'

                    def payload = """
{
  "@type": "MessageCard",
  "@context": "http://schema.org/extensions",
  "summary": "Salesforce Deployment",
  "themeColor": "28a745",
  "title": "üöÄ Salesforce Delta Deployment",
  "sections": [
    {
      "facts": [
        { "name": "üì¶ Target Org", "value": "${env.SF_CREDENTIALS}" },
        { "name": "‚è∞ Time", "value": "${env.CURRENT_TIME}" },
        { "name": "‚úÖ Status", "value": "${env.DEPLOY_STATUS}" },
        { "name": "üë§ Author", "value": "${env.COMMIT_AUTHOR ?: 'N/A'}" },
        { "name": "üî® Commit", "value": "${shortCommit}" },
        { "name": "üí¨ Message", "value": "${env.COMMIT_MESSAGE ?: 'N/A'}" }
      ]
    },
    {
      "title": "üìù Code Changes",
      "text": "```${env.CODE_DIFF}```"
    }
  ]
}
"""
                    writeFile file: 'teams_payload.json', text: payload

                    bat """
                        curl -H "Content-Type: application/json" ^
                             -X POST "%TEAMS_URL%" ^
                             --data-binary @teams_payload.json
                    """
                }

                cleanWs()
            }
        }
    }
}
