pipeline {
    agent any

    environment {
        SF_CREDENTIALS = 'deltaDeployment'
        ANT_HOME = tool 'Ant'
        PATH = "${ANT_HOME}/bin;${env.PATH}"

        DEPLOY_STATUS = 'SKIPPED'
        DEPLOY_ERROR = ''
        COMMIT_HASH = ''
        COMMIT_AUTHOR = ''
        COMMIT_MESSAGE = ''
        CODE_DIFF = ''
        CURRENT_TIME = ''
    }

    stages {

        stage('Checkout') {
            steps {
                echo 'üì• Checking out repository...'
                checkout scm
            }
        }

        stage('Collect Commit Details') {
            steps {
                script {
                    env.CURRENT_TIME = bat(
                        script: '@echo %date% %time%',
                        returnStdout: true
                    ).trim()

                    env.COMMIT_HASH = bat(
                        script: '@git log -1 --pretty=format:%%H',
                        returnStdout: true
                    ).trim()

                    env.COMMIT_AUTHOR = bat(
                        script: '@git log -1 --pretty=format:%%an',
                        returnStdout: true
                    ).trim()

                    env.COMMIT_MESSAGE = bat(
                        script: '@git log -1 --pretty=format:%%s',
                        returnStdout: true
                    ).trim()

                    env.CODE_DIFF = bat(
                        script: '@git diff --name-status HEAD~1 HEAD 2>nul',
                        returnStdout: true
                    ).trim()

                    if (!env.CODE_DIFF) {
                        env.CODE_DIFF = 'No file changes detected'
                    }

                    echo "Commit: ${env.COMMIT_HASH}"
                    echo "Author: ${env.COMMIT_AUTHOR}"
                    echo "Message: ${env.COMMIT_MESSAGE}"
                }
            }
        }

        stage('Detect Changes') {
            steps {
                echo 'üîç Detecting delta changes...'
                bat 'scripts\\find-changes.bat'
            }
        }

        stage('Validate Delta') {
            steps {
                script {
                    def deltaExists = fileExists('delta\\src')
                    def packageExists = fileExists('delta\\package.xml')

                    if (!deltaExists || !packageExists) {
                        echo '‚ö†Ô∏è No Salesforce metadata changes detected'
                        env.SKIP_DEPLOYMENT = 'true'
                        return
                    }

                    env.SKIP_DEPLOYMENT = 'false'

                    withCredentials([usernamePassword(
                        credentialsId: env.SF_CREDENTIALS,
                        usernameVariable: 'SF_USERNAME',
                        passwordVariable: 'SF_PASSWORD'
                    )]) {
                        try {
                            bat '''
                                ant -Dsf.username=%SF_USERNAME% ^
                                    -Dsf.password=%SF_PASSWORD% ^
                                    -Dsf.serverurl=https://login.salesforce.com ^
                                    -buildfile build\\build.xml ^
                                    deltaDeploy
                            '''
                            env.DEPLOY_STATUS = 'SUCCESS'
                        } catch (Exception e) {
                            env.DEPLOY_STATUS = 'FAILED'
                            env.DEPLOY_ERROR = e.getMessage()
                            throw e
                        }
                    }
                }
            }
        }

        stage('Run Tests') {
            when {
                allOf {
                    branch 'main'
                    expression { env.SKIP_DEPLOYMENT != 'true' }
                }
            }
            steps {
                echo 'üß™ Running Apex Tests...'
                withCredentials([usernamePassword(
                    credentialsId: env.SF_CREDENTIALS,
                    usernameVariable: 'SF_USERNAME',
                    passwordVariable: 'SF_PASSWORD'
                )]) {
                    bat '''
                        ant -Dsf.username=%SF_USERNAME% ^
                            -Dsf.password=%SF_PASSWORD% ^
                            -Dsf.serverurl=https://login.salesforce.com ^
                            -buildfile build\\build.xml ^
                            runTests
                    '''
                }
            }
        }
    }

    post {
        always {
            script {
                withCredentials([string(credentialsId: 'teams-webhook', variable: 'TEAMS_URL')]) {

                    def color = 'ffc107'
                    if (env.DEPLOY_STATUS == 'SUCCESS') color = '28a745'
                    if (env.DEPLOY_STATUS == 'FAILED') color = 'dc3545'

                    def payload = """
{
  "@type": "MessageCard",
  "@context": "http://schema.org/extensions",
  "summary": "Salesforce Deployment Notification",
  "themeColor": "${color}",
  "title": "üöÄ Salesforce Delta Deployment",
  "sections": [
    {
      "facts": [
        { "name": "üì¶ Target Org", "value": "${env.SF_CREDENTIALS}" },
        { "name": "‚è∞ Time", "value": "${env.CURRENT_TIME}" },
        { "name": "‚úÖ Status", "value": "${env.DEPLOY_STATUS}" },
        { "name": "üë§ Author", "value": "${env.COMMIT_AUTHOR}" },
        { "name": "üî® Commit", "value": "${env.COMMIT_HASH.substring(0,8)}" },
        { "name": "üí¨ Message", "value": "${env.COMMIT_MESSAGE}" }
      ],
      "markdown": true
    },
    {
      "title": "üìù Code Changes",
      "text": "```${env.CODE_DIFF}```"
    }
"""

                    if (env.DEPLOY_STATUS == 'FAILED') {
                        payload += """,
    {
      "title": "‚ùå Deployment Error",
      "text": "```${env.DEPLOY_ERROR}```"
    }
"""
                    }

                    payload += """
  ],
  "potentialAction": [
    {
      "@type": "OpenUri",
      "name": "View Jenkins Build",
      "targets": [
        { "os": "default", "uri": "${env.BUILD_URL}" }
      ]
    }
  ]
}
"""

                    writeFile file: 'teams_payload.json', text: payload

                    bat '''
                    curl -H "Content-Type: application/json" ^
                         -X POST "%TEAMS_URL%" ^
                         --data-binary @teams_payload.json
                    '''
                }
            }
        }

        success {
            echo '‚úÖ Pipeline completed successfully'
        }

        failure {
            echo '‚ùå Pipeline failed'
        }

        always {
            cleanWs()
        }
    }
}
