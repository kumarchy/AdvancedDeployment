pipeline {
    agent any

    environment {
        // Salesforce
        SF_CREDENTIALS = 'deltaDeployment'

        // Tools
        ANT_HOME = tool 'Ant'
        PATH = "${ANT_HOME}/bin;${env.PATH}"

        // Deployment info
        DEPLOY_STATUS = 'SKIPPED'
        DEPLOY_ERROR  = ''
        SKIP_DEPLOYMENT = 'false'

        // Git info
        COMMIT_HASH    = ''
        COMMIT_AUTHOR  = ''
        COMMIT_MESSAGE = ''
        CODE_DIFF      = ''
        CURRENT_TIME   = ''
    }

    stages {

        /* -----------------------------------------------------------
           CHECKOUT (single checkout only)
        ----------------------------------------------------------- */
        stage('Checkout') {
            steps {
                echo 'üì• Checking out source code...'
                checkout scm
            }
        }

        /* -----------------------------------------------------------
           COLLECT COMMIT DETAILS
        ----------------------------------------------------------- */
        stage('Collect Commit Details') {
            steps {
                script {
                    env.CURRENT_TIME = bat(
                        script: '@echo %date% %time%',
                        returnStdout: true
                    ).trim()

                    env.COMMIT_HASH = bat(
                        script: '@git rev-parse HEAD',
                        returnStdout: true
                    ).trim()

                    env.COMMIT_AUTHOR = bat(
                        script: '@git log -1 --pretty=format:%%an',
                        returnStdout: true
                    ).trim()

                    env.COMMIT_MESSAGE = bat(
                        script: '@git log -1 --pretty=format:%%s',
                        returnStdout: true
                    ).trim()

                    env.CODE_DIFF = bat(
                        script: '@git diff --name-status HEAD~1 HEAD',
                        returnStdout: true
                    ).trim()

                    if (!env.CODE_DIFF) {
                        env.CODE_DIFF = 'No file changes detected'
                    }

                    echo "üî® Commit : ${env.COMMIT_HASH}"
                    echo "üë§ Author : ${env.COMMIT_AUTHOR}"
                    echo "üí¨ Message: ${env.COMMIT_MESSAGE}"
                }
            }
        }

        /* -----------------------------------------------------------
           GENERATE DELTA (SOURCE OF TRUTH)
        ----------------------------------------------------------- */
        stage('Generate Delta Package') {
            steps {
                echo 'üîç Generating Salesforce delta...'
                bat 'scripts\\find-changes.bat'
            }
        }

        /* -----------------------------------------------------------
           VALIDATE + DEPLOY DELTA
        ----------------------------------------------------------- */
        stage('Validate & Deploy Delta') {
            steps {
                script {
                    def deltaSrcExists = fileExists('delta\\src')
                    def packageExists  = fileExists('delta\\package.xml')

                    if (!deltaSrcExists || !packageExists) {
                        echo '‚ö†Ô∏è No Salesforce metadata changes found. Skipping deployment.'
                        env.SKIP_DEPLOYMENT = 'true'
                        return
                    }

                    withCredentials([usernamePassword(
                        credentialsId: env.SF_CREDENTIALS,
                        usernameVariable: 'SF_USERNAME',
                        passwordVariable: 'SF_PASSWORD'
                    )]) {
                        try {
                            bat """
                                ant -Dsf.username=%SF_USERNAME% ^
                                    -Dsf.password=%SF_PASSWORD% ^
                                    -Dsf.serverurl=https://login.salesforce.com ^
                                    -buildfile build\\build.xml ^
                                    deltaDeploy
                            """
                            env.DEPLOY_STATUS = 'SUCCESS'
                        } catch (Exception e) {
                            env.DEPLOY_STATUS = 'FAILED'
                            env.DEPLOY_ERROR  = e.getMessage()
                            throw e
                        }
                    }
                }
            }
        }
    }

    /* -----------------------------------------------------------
       POST ACTIONS (SINGLE always BLOCK)
    ----------------------------------------------------------- */
    post {
        always {
            script {
                withCredentials([string(credentialsId: 'teams-webhook', variable: 'TEAMS_URL')]) {

                    def color = 'ffc107'
                    if (env.DEPLOY_STATUS == 'SUCCESS') color = '28a745'
                    if (env.DEPLOY_STATUS == 'FAILED')  color = 'dc3545'

                    def payload = """
{
  "@type": "MessageCard",
  "@context": "http://schema.org/extensions",
  "summary": "Salesforce Deployment",
  "themeColor": "${color}",
  "title": "üöÄ Salesforce Delta Deployment",
  "sections": [
    {
      "facts": [
        { "name": "üì¶ Target Org", "value": "${env.SF_CREDENTIALS}" },
        { "name": "‚è∞ Time", "value": "${env.CURRENT_TIME}" },
        { "name": "‚úÖ Status", "value": "${env.DEPLOY_STATUS}" },
        { "name": "üë§ Author", "value": "${env.COMMIT_AUTHOR}" },
        { "name": "üî® Commit", "value": "${env.COMMIT_HASH.take(8)}" },
        { "name": "üí¨ Message", "value": "${env.COMMIT_MESSAGE}" }
      ],
      "markdown": true
    },
    {
      "title": "üìù Code Changes",
      "text": "```${env.CODE_DIFF}```"
    }
  ],
  "potentialAction": [
    {
      "@type": "OpenUri",
      "name": "View Jenkins Build",
      "targets": [
        { "os": "default", "uri": "${env.BUILD_URL}" }
      ]
    }
  ]
}
"""

                    if (env.DEPLOY_STATUS == 'FAILED') {
                        payload = payload.replace(
                            ']',
                            """,
    {
      "title": "‚ùå Deployment Error",
      "text": "```${env.DEPLOY_ERROR}```"
    }
]"""
                        )
                    }

                    writeFile file: 'teams_payload.json', text: payload

                    bat """
                        curl -H "Content-Type: application/json" ^
                             -X POST "%TEAMS_URL%" ^
                             --data-binary @teams_payload.json
                    """
                }

                cleanWs()
            }
        }

        success {
            echo '‚úÖ Pipeline completed successfully'
        }

        failure {
            echo '‚ùå Pipeline failed'
        }
    }
}
