pipeline {
    agent any
    
    environment {
        // Salesforce credentials ID from Jenkins
        SF_CREDENTIALS = 'deltaDeployment'
        // Ant installation name from Jenkins Global Tool Configuration
        ANT_HOME = tool 'Ant'
        PATH = "${ANT_HOME}/bin:${env.PATH}"
    }
    
    stages {
        stage('Checkout') {
            steps {
                echo 'üì• Checking out code from repository...'
                checkout scm
            }
        }
        
        stage('Detect Changes') {
            steps {
                echo 'üîç Detecting changed files...'
                script {
                    def result = bat(
                        script: 'scripts\\find-changes.bat',
                        returnStatus: true
                    )
                    
                    if (result != 0) {
                        error "Failed to detect changes"
                    }
                }
            }
        }
        
        stage('Check Delta') {
            steps {
                echo 'üì¶ Checking if deployment is needed...'
                script {
                    // Check if delta folder has any Salesforce files
                    def deltaExists = fileExists('delta\\src')
                    def packageExists = fileExists('delta\\package.xml')
                    
                    if (!deltaExists || !packageExists) {
                        echo '‚ö†Ô∏è No Salesforce metadata changes detected.'
                        echo '‚ÑπÔ∏è Only files in force-app/main/default/ trigger deployments'
                        env.SKIP_DEPLOYMENT = 'true'
                        currentBuild.result = 'SUCCESS'
                        return
                    }
                    
                    // Check if src folder has any content
                    def srcHasFiles = bat(
                        script: '@dir /b /s delta\\src\\*.* 2>nul',
                        returnStatus: true
                    ) == 0
                    
                    if (!srcHasFiles) {
                        echo '‚ö†Ô∏è Delta folder exists but contains no metadata.'
                        env.SKIP_DEPLOYMENT = 'true'
                        currentBuild.result = 'SUCCESS'
                        return
                    }
                    
                    echo '‚úÖ Delta folder contains metadata. Proceeding with validation...'
                    env.SKIP_DEPLOYMENT = 'false'
                    
                    // Show what will be deployed
                    echo 'üìÑ Files to be deployed:'
                    bat 'type delta\\changed_files.txt'
                }
            }
        }
        
        stage('Validate Deployment') {
            when {
                expression { env.SKIP_DEPLOYMENT != 'true' }
            }
            steps {
                echo '‚úÖ Validating deployment (checkOnly=true)...'
                withCredentials([usernamePassword(
                    credentialsId: "${SF_CREDENTIALS}",
                    usernameVariable: 'SF_USERNAME',
                    passwordVariable: 'SF_PASSWORD'
                )]) {
                    script {
                        // Use environment variables instead of -D flags
                        bat """
                            set username=%SF_USERNAME%
                            set password=%SF_PASSWORD%
                            set serverurl=https://login.salesforce.com
                            cd build
                            ant validate
                        """
                    }
                }
            }
        }
        
        stage('Deploy to Salesforce') {
            when {
                allOf {
                    branch 'main'  // Only deploy from main branch
                    expression { env.SKIP_DEPLOYMENT != 'true' }
                }
            }
            steps {
                echo 'üöÄ Deploying to Salesforce...'
                withCredentials([usernamePassword(
                    credentialsId: "${SF_CREDENTIALS}",
                    usernameVariable: 'SF_USERNAME',
                    passwordVariable: 'SF_PASSWORD'
                )]) {
                    script {
                        bat """
                            set username=%SF_USERNAME%
                            set password=%SF_PASSWORD%
                            set serverurl=https://login.salesforce.com
                            cd build
                            ant deltaDeploy
                        """
                    }
                }
            }
        }
        
        stage('Run Tests') {
            when {
                allOf {
                    branch 'main'
                    expression { env.SKIP_DEPLOYMENT != 'true' }
                }
            }
            steps {
                echo 'üß™ Running Apex Tests...'
                withCredentials([usernamePassword(
                    credentialsId: "${SF_CREDENTIALS}",
                    usernameVariable: 'SF_USERNAME',
                    passwordVariable: 'SF_PASSWORD'
                )]) {
                    script {
                        bat """
                            set username=%SF_USERNAME%
                            set password=%SF_PASSWORD%
                            set serverurl=https://login.salesforce.com
                            cd build
                            ant runTests
                        """
                    }
                }
            }
        }
    }
    
    post {
        success {
            script {
                if (env.SKIP_DEPLOYMENT == 'true') {
                    echo '‚úÖ Build succeeded - No Salesforce changes to deploy'
                    echo '‚ÑπÔ∏è Pipeline completed without deployment'
                } else {
                    echo '‚úÖ Deployment succeeded!'
                    echo 'üéâ All stages completed successfully'
                }
            }
        }
        failure {
            echo '‚ùå Pipeline failed!'
            echo 'üîç Check the console output for details'
        }
        always {
            echo 'üßπ Cleaning up workspace...'
            // Archive artifacts for debugging
            archiveArtifacts artifacts: 'delta/**/*', allowEmptyArchive: true
            cleanWs()
        }
    }
}