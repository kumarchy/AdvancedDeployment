<project name="Salesforce CI/CD" default="deploy" basedir=".." xmlns:sf="antlib:com.salesforce">
    
    <!-- Load properties from build.properties -->
    <property file="build/build.properties"/>
    <property environment="env"/>
    
    <!-- Set default values for properties -->
    <!-- <condition property="sf.username" value="">
        <not><isset property="sf.username"/></not>
    </condition>
    <condition property="sf.password" value="">
        <not><isset property="sf.password"/></not>
    </condition> -->

<condition property="sf.username" value="${env.username}" else="${sf.username}">
    <isset property="env.username"/>
</condition>

<condition property="sf.password" value="${env.password}" else="${sf.password}">
    <isset property="env.password"/>
</condition>

<condition property="sf.serverurl" value="${env.serverurl}" else="https://login.salesforce.com">
    <isset property="env.serverurl"/>
</condition>

    
    <!-- Salesforce Ant task definition -->
    <taskdef resource="com/salesforce/antlib.xml" uri="antlib:com.salesforce">
        <classpath>
            <pathelement location="lib/ant-salesforce.jar"/>
        </classpath>
    </taskdef>
    
    <!-- Retrieve metadata from Salesforce org (this time only for demo) in real scenerios developers push code to github, so i need to 
    fetch that github code, not from salesforce org usually then validate and delta deploy-->
    <target name="retrieve">
        <echo message="Retrieving metadata from Salesforce..."/>
        <sf:retrieve username="${sf.username}" 
                     password="${sf.password}" 
                     serverurl="${sf.serverurl}" 
                     retrieveTarget="force-app/main/default" 
                     unpackaged="src/package.xml"
                     maxPoll="${sf.maxPoll}"/>
        <echo message="Retrieve completed successfully!"/>
    </target>
    
    <!-- Validate deployment and deploy (check only) -->
<target name="validate">
    <echo message="Validating deployment..."/>
    <sf:deploy username="${sf.username}" 
               password="${sf.password}" 
               serverurl="${sf.serverurl}" 
               deployRoot="force-app/main/default"
               checkOnly="false"
               testLevel="RunSpecifiedTests"
               rollbackOnError="true"
               maxPoll="${sf.maxPoll}">
        <runTest>ContactHandlerTest</runTest>
    </sf:deploy>
    <echo message="Validation completed successfully!"/>
</target>

<target name="deltaDeploy">
    <sf:deploy
        username="${sf.username}"
        password="${sf.password}"
        serverurl="${sf.serverurl}"
        deployRoot="delta"
        checkOnly="false"
        testLevel="NoTestRun"
        rollbackOnError="true"
        maxPoll="${sf.maxPoll}"
    />
</target>


    <!-- Quick deploy using recent validation ID -->
    <target name="quickDeploy">
        <echo message="Executing quick deploy..."/>
        <sf:deployRecentValidation username="${sf.username}" 
                                   password="${sf.password}" 
                                   serverurl="${sf.serverurl}" 
                                   recentValidationId="${sf.recentValidationId}"
                                   maxPoll="${sf.maxPoll}"/>
        <echo message="Quick deploy completed successfully!"/>
    </target>
    
    <!-- Run all tests -->
    <target name="runTests">
        <echo message="Running all tests..."/>
        <sf:deploy username="${sf.username}" 
                   password="${sf.password}" 
                   serverurl="${sf.serverurl}" 
                   deployRoot="force-app/main/default"  
                   checkOnly="true"
                   testLevel="RunAllTestsInOrg"
                   rollbackOnError="true"
                   maxPoll="${sf.maxPoll}"/>
        <echo message="Tests completed!"/>
    </target>
    
    <!-- List metadata of a specific type -->
    <target name="listMetadata">
        <echo message="Listing metadata of type: ${sf.metadataType}"/>
        <sf:listMetadata username="${sf.username}" 
                        password="${sf.password}" 
                        serverurl="${sf.serverurl}" 
                        metadataType="${sf.metadataType}"/>
    </target>
    
    <!-- Describe all metadata types -->
    <target name="describeMetadata">
        <echo message="Describing all metadata types..."/>
        <sf:describeMetadata username="${sf.username}" 
                            password="${sf.password}" 
                            serverurl="${sf.serverurl}"/>
    </target>
    
</project>